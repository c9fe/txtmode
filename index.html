<!DOCTYPE html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1.0">
<title>txtmode | convert files to txt and back</title>
<h1>txtmode &mdash; convert files to txt and back</h1>
<script src=words.js></script>
<script src=b64order.js></script>
<script src=toWords.js></script>
<script src=fromWords.js></script>
<main>
  <form>
    <p>
      <input required type=file id=file name=file>
    <p>
      <label>
        <input required type=checkbox> 
        I agree this tool is provided as is, and I am responsible for my use of it. 
        <br>
        The provider is not responsible for any damage incurred as a result of its use.
      </label>
    <p>
      <button>Process</button>
    <script>
      "use strict";
      {
        Object.assign(self, {processFile});
        
        const form = document.currentScript.closest('form');
        const file = form.querySelector('#file');
        
        form.addEventListener('submit', e => processFile(e) );
        
        function processFile(e) {
          e.preventDefault();
          const fileNode = file.files[0];
          if ( fileNode.name.includes('_txtmode_') && fileNode.name.endsWith('.txt') ) {
            return processTxt(fileNode);
          }
          const reader = new FileReader();
          form.querySelector('button').disabled = true;
          form.querySelector('button').innerText = 'processing...';
          reader.addEventListener('load', () => {
            const [mimeDataPrefix, content] = reader.result.split(',');
            const encodedName = toWords(btoa(unescape(encodeURIComponent(fileNode.name))));
            const encodedMimeDataPrefix = toWords(btoa(mimeDataPrefix));
            const encodedContent = toWords(content);
            const fileContent = `${encodedName}\n\n${encodedMimeDataPrefix}\n\n${encodedContent}\n\n`;
            const txtMode = `data:text/plain;base64,${btoa(fileContent)}`;
            const anchor = document.createElement('a');
            anchor.download = `${fileNode.name}._txtmode_.txt`;
            // name hiding
            // anchor.download = `${+ new Date}._txtmode_.txt`;
            anchor.innerText = `Download ${anchor.download}`;
            anchor.href = txtMode;
            document.querySelector('section.downloads ol').insertAdjacentHTML('afterbegin','<li></li>');             
            document.querySelector('section.downloads ol li').insertAdjacentElement('afterbegin', anchor );
            form.querySelector('button').disabled = false;
            form.querySelector('button').innerText = 'Process';
          });
          reader.readAsDataURL(fileNode);
        }

        function processTxt(file) {
          const reader = new FileReader();
          form.querySelector('button').disabled = true;
          form.querySelector('button').innerText = 'processing...';
          reader.addEventListener('load', () => {
            const [encodedName, encodedMimeDataPrefix, encodedContent] = reader.result.split('\n\n');
            const name = decodeURIComponent(escape(atob(fromWords(encodedName))));
            const mimeDataPrefix = atob(fromWords(encodedMimeDataPrefix));
            const content = fromWords(encodedContent);
            const originalMode = `${mimeDataPrefix},${content}`;
            const anchor = document.createElement('a');
            anchor.download = `${name}`;
            anchor.innerText = `Download ${anchor.download}`;
            anchor.href = originalMode;
            document.querySelector('section.downloads ol').insertAdjacentHTML('afterbegin','<li></li>');             
            document.querySelector('section.downloads ol li').insertAdjacentElement('afterbegin', anchor );
            form.querySelector('button').disabled = false;
            form.querySelector('button').innerText = 'Process';
          });
          reader.readAsText(file);
        }
      }
    </script>
  </form>
  <section class=downloads>
    <h1>Note: any files for download here will not persist beyond page reload.</h1>
    <ol>
    </ol>
    <p>
      <span class=nothing-yet>Upload a file to create more txt files to download.</span>
  </section>
</main>
